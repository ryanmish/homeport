FROM codercom/code-server:latest

USER root

# Install Node.js, npm, gh CLI, and common dev tools
RUN apt-get update && apt-get install -y \
    curl \
    git \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest \
    # Install GitHub CLI
    && curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y gh \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install common global packages and Claude Code
RUN npm install -g pnpm yarn @anthropic-ai/claude-code

# Copy custom entrypoint
COPY entrypoint-code-server.sh /usr/local/bin/entrypoint-code-server.sh
RUN chmod +x /usr/local/bin/entrypoint-code-server.sh

USER coder

# Create settings directory and copy custom settings
RUN mkdir -p /home/coder/.local/share/code-server/User
COPY --chown=coder:coder code-server-settings.json /home/coder/.local/share/code-server/User/settings.json

# Create a workspace settings file that opens terminal on startup
RUN mkdir -p /home/coder/repos/.vscode && \
    echo '{"workbench.startupEditor":"none","terminal.integrated.tabs.defaultIcon":"terminal"}' > /home/coder/repos/.vscode/settings.json && \
    chown -R coder:coder /home/coder/repos/.vscode

# Create Claude Code config directory (will be mounted as volume for persistence)
RUN mkdir -p /home/coder/.claude && \
    chown -R coder:coder /home/coder/.claude

ENTRYPOINT ["/usr/local/bin/entrypoint-code-server.sh"]
