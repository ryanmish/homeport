FROM codercom/code-server:latest

USER root

# Install Node.js, npm, and common dev tools
RUN apt-get update && apt-get install -y \
    curl \
    git \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install common global packages and Claude Code
RUN npm install -g pnpm yarn @anthropic-ai/claude-code

USER coder

# Create settings directory and copy custom settings
RUN mkdir -p /home/coder/.local/share/code-server/User
COPY --chown=coder:coder code-server-settings.json /home/coder/.local/share/code-server/User/settings.json

# Create a workspace settings file that opens terminal on startup
RUN mkdir -p /home/coder/repos/.vscode && \
    echo '{"workbench.startupEditor":"none","terminal.integrated.tabs.defaultIcon":"terminal"}' > /home/coder/repos/.vscode/settings.json && \
    chown -R coder:coder /home/coder/repos/.vscode
