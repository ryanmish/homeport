services:
  # Homeport Daemon
  # Uses network_mode: host to access localhost ports (Linux only)
  homeportd:
    image: homeport:${HOMEPORT_VERSION:-latest}
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        VERSION: ${HOMEPORT_VERSION:-auto}
    container_name: homeportd
    network_mode: host
    pid: "host"  # Required to see processes from other containers for port-repo association
    depends_on:
      homeportd-init:
        condition: service_completed_successfully
    volumes:
      - homeport-data:/srv/homeport/data
      - repos:/srv/homeport/repos
      # Mount host's gh CLI config for GitHub integration
      - ${HOME}/.config/gh:/home/homeport/.config/gh
      # Claude Code config (persistent volume + instructions file)
      - claude-config-homeport:/home/homeport/.claude
      - ./CLAUDE.md:/home/homeport/.claude/CLAUDE.md:ro
      # Docker socket and repo directory for self-upgrade capability
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/homeport-compose
      - ..:/homeport-repo
    environment:
      - HOMEPORT_EXTERNAL_URL=${EXTERNAL_URL:-http://localhost}
      - HOMEPORT_COOKIE_SECRET=${COOKIE_SECRET:-}
      - HOMEPORT_PASSWORD_HASH=${ADMIN_PASSWORD_HASH:-}
      - HOMEPORT_REPO_PATH
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/api/status"]
      interval: 30s
      timeout: 3s
      retries: 3

  # Init container to fix volume permissions for code-server
  code-server-init:
    image: alpine:latest
    container_name: code-server-init
    volumes:
      - code-server-data:/data
      - code-server-config:/config
      - claude-config:/claude
    command: sh -c "chown -R 1000:1000 /data /config /claude"
    restart: "no"

  # Init container to fix volume permissions for homeportd
  homeportd-init:
    image: alpine:latest
    container_name: homeportd-init
    volumes:
      - claude-config-homeport:/claude
    command: sh -c "chown -R 1000:1000 /claude"
    restart: "no"

  # Code Server (browser-based VS Code)
  code-server:
    build:
      context: .
      dockerfile: Dockerfile.code-server
    container_name: code-server
    network_mode: host
    depends_on:
      code-server-init:
        condition: service_completed_successfully
    volumes:
      - repos:/home/coder/repos
      - code-server-data:/home/coder/.local/share/code-server
      - code-server-config:/home/coder/.config/code-server
      - ${HOME}/.config/gh:/home/coder/.config/gh
      - claude-config:/home/coder/.claude
      - ./code-server-settings.json:/home/coder/.local/share/code-server/User/settings.json:ro
      - ./CLAUDE.md:/home/coder/.claude/CLAUDE.md:ro
    environment:
      - PASSWORD=${CODE_SERVER_PASSWORD:-}
      - DOCKER_USER=coder
    command:
      - --bind-addr=127.0.0.1:8443
      - --auth=${CODE_SERVER_AUTH:-none}
      - --disable-telemetry
      - --disable-getting-started-override
      - /home/coder/repos
    restart: unless-stopped

  # Caddy Reverse Proxy
  # Handles TLS and routes traffic to services
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    network_mode: host
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    environment:
      - DOMAIN=${DOMAIN:-localhost}
    restart: unless-stopped
    depends_on:
      - homeportd
      - code-server

volumes:
  homeport-data:
  repos:
  code-server-data:
  code-server-config:
  claude-config:
  claude-config-homeport:
  caddy-data:
  caddy-config:
